# Fyrlang Memory Benchmarks

This repository contains the code used to benchmark the [Fyr](https://github.com/vs-ude/fyrlang) compiler memory allocator performance.

## Prerequisites

For full functionality the following binaries and libraries need to be provided by the system:
- gcc
- [perf](https://perf.wiki.kernel.org/index.php/Main_Page)
- [Flamegraph](https://github.com/brendangregg/FlameGraph)
- GNU time
- Fyr compiler
- Fyr native libraries

## Run

Setup the `fyrlang-native-libs`.  
Setup the `.env` file by copying `.env_example` and filling in the correct values.  

Run
```
make -B FYR_NATIVE_MALLOC=jemalloc all
make -B FYR_NATIVE_MALLOC=jemalloc bench_all
make -B FYR_NATIVE_MALLOC=tcmalloc all
make -B FYR_NATIVE_MALLOC=tcmalloc bench_all
```

Now you can inspect the logfiles in `logs/`.
To run specific compilations or benchmarks, see the list generated by `make list_targets`.

## Options

You can configure the benchmarks behavior using the `.env` and `src/common/measurement.h` files.  
Additionally there are some options available via environment variables.
- `FYR_NATIVE_MALLOC=x` passed to `make` will cause the binaries to use the given `malloc` implementation. Also pass `-B` to ensure that everything is properly rebuilt.
- `SET_TIMESTAMP=y` will cause the benchmarks to be logged in timestamped files.
